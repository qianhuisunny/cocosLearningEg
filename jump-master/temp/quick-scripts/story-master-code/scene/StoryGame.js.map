{"version":3,"sources":["StoryGame.js"],"names":["GameUtil","require","StoryData","StoryAudioMgr","cc","Class","extends","properties","storyNode","default","displayName","type","Node","touchNode","isTest","_piece","_pieceData","_plotData","_getMsgList","StoryMaster","Msg","OnGoNextPiece","OnJumpNewPlot","OnEnableGlobalTouch","_onMsg","t","e","id","i","getNextPieceItemByKeyAndPrefab","piece","createPiece","getNextPlotData","getPieceDataByID","stopAll","off","EventType","TOUCH_END","_onTouchEnd","_playNewPlot","active","ObserverMgr","dispatchMsg","UserTouch","_initTouch","view","getVisibleSize","width","height","on","onLoad","debug","setDisplayStats","StoryConfig","init","_initMsg","destroyAllChildren","serializePlot","startWithDebug","startWithNormal","bind","_onPieceTips","addComponent","Label","string","addChild","getUnitPiecePrefab","getPlotDataByPieceID","item","getBeganPlot","_playNextPiece","getPlotDataByID","Type","Pieces","Content","prefab","transformUrl","loader","loadRes","cleanAudioEffect","instantiate","o","x","y","a","getComponent","pieceItem","PlotJump","getPieceDataByPlotID","jump","length","start"],"mappings":"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","file":"StoryGame.js","sourceRoot":"../../../../../../../.CocosCreator/packages/story-master/code/scene","sourcesContent":["let GameUtil=require(\"GameUtil\"),StoryData=require(\"StoryData\"),StoryAudioMgr=require(\"StoryAudioMgr\");cc.Class({extends:require(\"Observer\"),properties:{storyNode:{default:null,displayName:\"故事节点\",type:cc.Node},touchNode:{default:null,displayName:\"触摸节点\",type:cc.Node},isTest:!1,_piece:null,_pieceData:null,_plotData:null},_getMsgList:()=>[cc.StoryMaster.Msg.OnGoNextPiece,cc.StoryMaster.Msg.OnJumpNewPlot,cc.StoryMaster.Msg.OnEnableGlobalTouch],_onMsg(t,e){if(t===cc.StoryMaster.Msg.OnGoNextPiece){let t=e.id,i=StoryData.getNextPieceItemByKeyAndPrefab(this._plotData.piece,t);if(i)this.createPiece(i);else{let t=StoryData.getNextPlotData(this._plotData.id);if(t){this._plotData=t;let e=StoryData.getPieceDataByID(t.piece);e&&(this._pieceData=e,this.createPiece(e[0]))}else this._plotData=null,this._pieceData=null,this._piece=null,StoryAudioMgr.stopAll(),this.touchNode.off(cc.Node.EventType.TOUCH_END,this._onTouchEnd,this)}}else t===cc.StoryMaster.Msg.OnJumpNewPlot?this._playNewPlot(e):t===cc.StoryMaster.Msg.OnEnableGlobalTouch&&(this.touchNode.active=!!e)},_onTouchEnd(){cc.ObserverMgr.dispatchMsg(cc.StoryMaster.Msg.UserTouch,null)},_initTouch(){let t=cc.view.getVisibleSize();this.touchNode.width=t.width,this.touchNode.height=t.height,this.touchNode.active=!0,this.touchNode.on(cc.Node.EventType.TOUCH_END,this._onTouchEnd,this)},onLoad(){cc.debug.setDisplayStats(!1),cc.StoryConfig.init(function(){this._initMsg(),this.storyNode.destroyAllChildren(),this.touchNode.destroyAllChildren(),this._initTouch(),StoryData.serializePlot(),this.isTest?this.startWithDebug():this.startWithNormal()}.bind(this))},_onPieceTips(t){this.storyNode.destroyAllChildren();let e=new cc.Node;e.addComponent(cc.Label).string=t,this.storyNode.addChild(e),this.touchNode.off(cc.Node.EventType.TOUCH_END,this._onTouchEnd,this)},startWithDebug(){let t=StoryData.getUnitPiecePrefab();if(t){let e=StoryData.getPlotDataByPieceID(t.piece);if(e){this._plotData=e;let i=StoryData.getPieceDataByID(t.piece);i&&(this._pieceData=i,this.createPiece(t.item))}}else this._onPieceTips(\"未发现要测试的故事\")},startWithNormal(){let t=StoryData.getBeganPlot();this._playNewPlot(t.id)},_playNextPiece(){},_playNewPlot(t,e){let i=StoryData.getPlotDataByID(t);if(i){this._plotData=i;let t=StoryData.getPieceDataByID(i.piece);t&&(this._pieceData=t,this.createPiece(t[0]))}},createPiece(t){if(t&&t.type===cc.StoryMaster.Type.Pieces.Content||void 0===t.type){let e=t.prefab;e&&(e=GameUtil.transformUrl(e),cc.loader.loadRes(e,function(e,i){if(e);else{cc.ObserverMgr.dispatchMsg(cc.StoryMaster.Msg.OnEnableGlobalTouch,!0),StoryAudioMgr.cleanAudioEffect(),this.storyNode.destroyAllChildren();let e=cc.instantiate(i),o=cc.view.getVisibleSize();e.x=e.y=0,e.width=o.width,e.height=o.height,this.storyNode.addChild(e);let a=e.getComponent(\"StoryPiece\");a&&(a.pieceItem=t)}}.bind(this)))}else if(t&&t.type===cc.StoryMaster.Type.Pieces.PlotJump){let e=StoryData.getPieceDataByPlotID(t.jump);e&&e.length>0&&this._playNewPlot(t.jump)}},start(){}});"]}